---
title: 第三章|存储系统
weight: 3
---
# 存储器概述
## 存储器的层次结构
寄存器 Cache(高速缓冲存储器) 主存(内存) 磁盘(辅存) 磁带、光盘。  

![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306121558197.png)


主存-辅存：实现了虚拟存储系统，结果主存容量不够的问题。辅存与主存内容交换一般是由硬件和操作系统完成，涉及到操作系统中的页面置换算法。   
Cache-主存：解决了主存与CPU速度不匹配的问题。是由硬件自动完成的。   
辅存的数据必须调入主存后才能被CPU访问。   
频繁被访问的数据可以复制一份到Cache中，更方便CPU读取。   
CPU进行一些加减运算时，操作数就存在寄存器，寄存器访问更快，但是其价格贵，数量更少。    
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306121558271.png)

## 存储器的分类
#### 按层次分类
高速缓存  
主存储器  
辅助存储器  
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306121607679.png)
#### 按存储介质分类
半导体存储器：主存、Cache   
磁表面存储器：磁盘、磁带   
光存储器：光盘   
#### 按存取方式分类
- 随机存取存储器（Random Acess Memory）：
读写任何一个存储单元所需时间都一样，与物理位置无关。   
- 顺序存取存储器（Sequential Acess Memory）：
读写每一个存储单元所需的时间取决于存储单元所在的物理位置。   
- 直接存取存储器（Direct Acess Memory）：
既有随机读取的特性，又有顺序读取的特性，先随机选取目标数据扇区，再顺序方式读取数据。   
顺序存取和直接读取都是串行访问存储器，读写某个存储单元所需时间与存储器单元的物理位置有关。   
- 相联存储器（Associative Memory）：
即可以按内容访问的存储器，也可以按照内容检索到存储位置进行读写，“快表”就是一种。  
#### 按信息的更改性分类
读写存取器：可读可写（磁盘，内存，Cache等）    
只读存储器（Read Only Memory）：只能读，不能写。（BIOS写到ROM上，实体音乐专辑存储到CD-ROM上）   
#### 按信息的可保存性分类
易失性存储器：断电后存储信息消失，（Cache、主存）    
非易失性存储器：断电后存储信息依旧保存，（磁盘、光盘）    
破坏性读出：信息读出后，原存储信息被破坏。（DRAM芯片，读出数据后要进行重写）    
非破坏性读出：信息读出后，原存储信息不被破坏。（SRAM、磁盘、光盘）    
### 存储器的性能指标
存储容量：存储字数 \* 字长（如1M\*8位)    
MDR位数反映存储字长，MAR位数反映存储字数。   
单位成本：每位(bit)价格 = 总成本 / 总容量   
存储速度：数据传输率=数据的宽度/存储周期。      
数据宽度位存储字长。   

![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306121635855.png)

存储周期包括存取时间和恢复时间。  
存取时间是从一次启动存储器操作到完成该操作所经历的时间，分为读出时间和写入时间。  
存储周期也被称为读写周期或访问周期。指存储器进行一次完整的读写操作所需的全部时间，即连续两次独立地访问存储器操作之间所需的最小时间间隔。   

主存带宽又称为数据传输率。表示每秒从主存进出信息的最大数量。单位为字、字节Byte、位bit 每秒。  
# 主存储器
## 主存储器的基本组成
### 基本半导体元件
MOS管：施加的电压达到某个阈值，MOS管就可以连通。   
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306121641169.png)
MOS管接通后，电容与外部导线连接。  
电容如果存储的电荷在放电后电荷流出，外部导线监测到高电平即信号1，若电容不存储电荷，则外部导线监测到低电平即信号0。  
### 存储芯片的结构
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306121645513.png)
存储字长与每个存储体设计有关。  
与CPU相连的地址总线连通MAR，然后通过译码器连接存储的单元的字选线来选择。字选线    
与CPU与相连的数据总线宽度未存储字长，即图中绿线。位选线。    
存储体总容量为 存储单元个数 \* 存储字长。    
控制电路    
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306121655339.png)

片选线：一个内存条可能包含多个存储芯片，用片选线来判断选择的存储芯片编号。   
读写控制线：可能为两根，一根控制写，一根控制读，或只用一根。向外暴露的引脚个数。      
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306121656037.png)
上图中每个线都会对应一个金属引脚。     
n位地址 对应 2<sup>n</sup>的存储单元。    
8K \* 8位 即2<sup>13</sup> \* 8bit容量，地址线有13位，数据线有8位。    
###  寻址
现代计算机通常按字节编址，即每个字节对应一个地址。   
对于总容量为1KB的存储体。地址线为10条，数据线为8条    
- 按字节寻址，1K个单元，每个单元存储1B的二进制数据。  
- 按字寻址，将四个连续的字节合并为一个字，一次读取一个字，即256个单元，每个单元4B，字节地址算数左移两位转换为按字寻址的地址。
- 按半字寻址，将连续的两个字节合并为一个字。总共512个单元，每个单元存储2B的二进制数据。
- 按双字寻址，将连续的八个字节合并为一个字。总共128个单元，每个单元存储8B的二进制数据。
## SRAM与DRAM
静态RAM与动态RAM    
DRAM一般用于主存，SRAM一般用于Cache  
### 存储元件不同而导致的特性差异
##### 栅极电容
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306121734757.png)
电容放电后，信息会被破坏，是破坏性读出，读出后应该对数据重写。
每个存储元制造成本低，集成度高，功耗低。  
电容中的电荷信息即使不读取也会丢失，一般只能维持2ms，所以需要频繁对电容进行刷新。  
##### 双稳态触发器
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306121735704.png)
有两种稳定的状态：
1：A高电平，B低电平。  
0：A低电平，B高电平。  
读出数据后，触发器状态依旧稳定，读数据为非破坏性读出，无需重写。  
每个存储元制造成本高，器件多，集成度低，功耗高。  
##### 两种器件的特性对比：
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306121740416.png)
两种断电之后信息都会消失，都是易失性读出。  
### DRAM的刷新
#### 多久需要刷新一次？  
刷新周期一般为2ms，  
#### 每次刷新多少存储单元？  
以行为单位，每次刷新一行存储单元。   
简单模型为存储单元按号排序，如果采用20位地址线就，那么就要排0到2<sup>20</sup> - 1号存储单元，也就是需要出2<sup>20</sup>条线，显然很难实现。
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306121758329.png)
如果用行列地址来定址，那么只需要一个行地址译码器和一个列地址译码器，每个译码器只需要确定0到1023号，相比来说减少了很多。地址分为行地址和列地址，前半部分为行地址，后半部分为列地址。减少了连通线的数量。     
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306121759394.png)  
#### 如何刷新？
有相关硬件支持，由存储器独立完成，不需要CPU控制。每次读取一行存储单元的信息后，重新写入，占用1个读/写周期。  
#### 在什么时候刷新呢？
假设DRAM内部结构排列成128x128的形式，读写周期为0.5us，2ms共2ms/0.5us = 4000个周期。
1. 分散刷新
每次读写玩都刷新一行，系统的存储周期会变长，前0.5us时间用于正常读写，后0.5us时间用于刷新，系统存储周期变为1us。  
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306121948120.png)

2. 集中刷新
选择2ms集中安排时间全部刷新，系统的存储周期不变，但有一段时间专门用于刷新，此时无法访问存储器，称之为“死区”  
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306121950650.png)

3. 异步刷新
2ms内每行刷新一次即可-> 2ms内需要产生128次刷新请求即，每隔2ms/128 = 15.6us一次，而每15.6us就有0.5us的死时间，相比集中刷新，异步刷新更分散。    
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306121953167.png)
### DRAM的地址线复用技术
由上边可知，DRAM如果存储单元过多，会导致译码器所需连接线过多，所以采用了行列地址来定址，每次刷新都是可以直接刷新一行，根据这个特性，可以在送行列地址时，将地址分为两次发送，一次为行，一次为列，通过相同的引脚输入。这样可以使地址线数减半，芯片引脚中地址引脚数减半。    
现在主流主存储器采用SDRAM，DRAM被淘汰了。
## 只读存储器ROM
### 常见ROM
ROM芯片是非易失性的，即断电后数据不会丢失。  
一般有MROM、PROM、EPROM、闪存、SSD等。
- MROM掩模式只读存储器，
一次写入后，之后任何人不可以重写。可靠性高，集成度高，价格便宜；缺点是灵活性差。
- PROM可编程只读存储器，
用户可以用专门的PROM写入器写入信息，写入一次后就不能更改。 
- EPROM可擦除可编程只读存储器
用户可以通过编程器写入信息，也可以进行多次修改，虽然即可读又可以写，但是编程次数有限，不能替代RAM。   
LIVEPROM 用紫外写照射8-20分钟，可以擦除所有信息。    
EEPROM 可以用电擦除的方式，擦除特定的字。   
- Flash Memory 闪存
由EEPROM发展而来，可用长期保存信息，也可以在线进行快速擦除与重写，既有价格便宜集成度高的特点，断电后可以保存信息，并且可以进行多次快速擦除重写。闪存需要先擦除再写入，因此闪存的“写”速度要比“读”慢。每个存储单元 只需要单个MOS管，位密度比RAM高。
- Soil State Drivers 固态硬盘
由控制单元加存储单元（Flash芯片）构成，与Flash核心区别在于控制单元不同，可以进行多次快速擦除重写，速度快，功耗低，价格高。 
### 计算机内重要的ROM
电脑关机后，RAM不通电，其内部的数据全部丢失，计算机下次开机时需要启动代码，这部分代码存在主板上的一块ROM中（BIOS），逻辑上一般将这一块与主存放到一起。编址时，一般将这块ROM上的内容编写到地址首位。   
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306122026529.png)

## 双端口RAM和多模块存储器
主存的优化技术。
##### 存取周期
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306122036703.png)
如果有多核CPU都要访存，怎么办？CPU读写速度比主存快很多，主存恢复时间太长怎么办？   
### 双端口RAM（大纲已删）
主要作用: 优化多核CPU访问同一根内存条的速度。    
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306122041578.png)   

主存需要有完全两组独立的数据线、地址线、控制线。CPU、RAM中也要有更复杂的控制电路。  
两个端口对同一主存进行操作有4中情况：
1. 两个端口同时对不同的地址单元存取数据。 允许
2. 两个端口同时对同一的地址单元读出数据。 允许
3. 两个端口同时对同一的地址单元写入数据。 写入错误
4. 两个端口同时对同一的地址单元，一个读入数据，一个写入数据。 读出错误
如果出现3 4的情况，置忙信号，由判断逻辑暂时关闭一个端口（延时接入），另一个端口正常访问。  
### 多模块存储器
利用多个结构相同的存储模块的并行工作来提高存储器的吞吐率。  
CPU的速度比存储器快，若同时从存储器中取出n条指令，就可以充分利用CPU资源，提高运行速度。多体交叉存储器就是基于这种思想实现的。  
存储体中存的多数数据是连续存储的，比如数组。    
#### 单体多字存储器
单体多字存储器就是，存储器中只有一个存储体，每个存储单元存储m个字，总线宽度也为m个字。一次并行读出m个字，地址必须顺序排列并处于同一存储单元。   
在一个存储周期内，从同一地址取出m条指令，然后将指令逐条送至CPU，即每隔1/m个存取周期，CPU向主存读取一条命令，显然提高了单体存储器的工作速度。但是只有当指令和数据是连续存放的，效果才比较明显。  
#### 多体并行存储器
多体并行存储器由多模块组成，每个模块都有相同的容量和存取速度，每个模块都有独立的读写控制电路、地址寄存器、数据寄存器。既能并行工作，也能交叉工作。![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306122126242.png)

##### 高位交叉编址（顺序方式）
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306122104248.png)
高位交叉编址其实就还是将多个存储器串行存取，实际上还是顺序存储器。每次读取一次后，需要再等待恢复周期，实际并不能提高效率。   
以连续访问00000-00100地址为例：  
设每个存储体存取周期为T，存取时间为r，T=r + 3r   
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306122109750.png)   
则总耗时为5T  
##### 低位交叉编址（交叉方式）
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306122105240.png)  
低位交叉编址是将地址低位设为存储体序号，则CPU读取第一个存储体的内容后，下一个连续地址是下一个存储体的地址，这样可以不用等待前面存储体的恢复周期，从而实现连续读取。 相比高位编址，可以提高效率。    
以连续访问00000-00100地址为例：  
设每个存储体存取周期为T，存取时间为r，T=r + 3r    
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306122110146.png)  
则总耗时为T + 4r。 如果连续读取n个存储字，总耗时为T + (n - 1)r，当n足够大时，读取单个存储字的时间约等于r。   
###### 那么应该取几个“体”
低位交叉编址的方式类似于“流水线”的方式进行并行存取，一个存储周期内，m体交叉存储器可以提供的数据量为单个的m倍。  
存取周期为T，存取时间为r，为了使刘淑霞不间断，应该保证模块数m >= T/r。 
存取周期为T，总线传输周期为r，为了使刘淑霞不间断，应该保证模块数m >= T/r。  
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306122122806.png)
如果m = T / r则刚好完美衔接。  
# 主存储器与CPU连接
#### 字扩展
扩展主存字数
#### 位扩展
数据总线宽度大于存储芯片
# 外部存储器
# 高速缓冲器
# 虚拟存储器

