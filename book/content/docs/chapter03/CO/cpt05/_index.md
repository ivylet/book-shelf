---
title: 第五章|中央控制器
weight: 5
---
# CPU的功能和基本结构
## CPU的功能
中央处理器CPU由运算器和控制器组成。其中，控制器的功能是负责协调并控制计算机各部件执行程序的指令序列。包括取指令、分析指令和执行指令；运算器的功能是对数据进行加工。CPU的具体功能包括：    
- 指令控制
	- 完成取指令、分析指令和执行指令的操作，即程序的顺序控制。
- 操作控制
	- 一条指令的功能往往是由若干操作信号的组合来实现的。CPU管 理并产生由内存取出的每条指令的操作信号，把各种操作信号送往相应的部件， 从而控制这些部件按指令的要求进行动作。
- 时间控制
	- 对各种操作加以时间上的控制。时间控制要为每条指令按时间 顺序提供应有的控制信号。
- 数据加工
	- 对数据进行算术和逻辑运算。
- 中断处理
	- 对计算机运行过程中出现的异常情况和特殊请求进行处理。
## CPU的基本结构
在计算机系统中，CPU主要由运算器和控制器两大部分组成。    
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306241515401.png)
### 运算器
运算器接收从控制器送来的命令并执行相应的动作，对数据进行加工和处理。运算器是计算机对数据进行加工处理的中心，它主要由算术逻辑单元ALU、暂存寄存器、累加寄存器ACC、通用寄存器、程序状态字寄存器PSW、移位器、计数器CT等组成。    
- 算数逻辑单元
	- 主要功能是进行算数/逻辑运算
- 暂存寄存器
	- 用于暂存从主存读来的数据，该数据不能存在通用寄存器中，否则会破坏原有内容。暂存寄存器对程序员是透明的。
- 累加寄存器
	- 它是一个通用寄存器，用于暂时存放ALU运算的结果信息，可以作为加法运算的一个输入端。  
	- 如：两个操作数分别来自主存和R<sub>0</sub>，最后结果存回R<sub>0</sub>， 那么从主存中取来的操作数直接放入暂存器，就不会 破坏运算前R<sub>0</sub>的内容。
- 通用寄存器组
	- 如AX、BX、CX、DX、SP等，用于存放操作数（包括源操作数、目的操作数及中间结果）和各种地址信息等。SP是堆栈指针，用于指示栈顶的指针。
- 程序状态字寄存器
	- 保留由算数逻辑运算指令或测试指令的结果而建立的各种状态信息，例如溢出标志OF、符号标志SF、零标志ZF、进位标志CF等。PSW这些位参与并决定微操作的形成。
- 移位器
	- 对操作数或运算结果进行移位运算
- 计数器
	- 控制乘除运算的操作步数

CPU内部单总线方式：将所有寄存器的输入端和输出端都连接到一条公共的通路上。 这样结构简单，容易实现。但数据传输存在较多冲突的现象。性能较低。    
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306241536553.png)

### 控制器
控制器是整个系统的指挥中枢，在控制器的控制下，运算器、存储器和输入/输出设备等功能部件构成一个有机整体，根据指令的要求指挥全机协调工作。控制器的基本功能是执行指令，每条指令的执行是由控制器发出的一组微操作实现的。   
控制器有硬布线控制器和微程序控制器两种类型。     
- 程序计数器
	- 用于指出下一条指令在主存中的存放 地址。CPU就是根据PC的内容去主存中取指令的。因 程序中指令（通常）是顺序执行的，所以PC有自增 功能。
- 指令寄存器IR
	- 用于存放当前正在执行的那条指令
- 指令译码器
	- 仅对操作码字段进行译码，想控制器提供特定的操作信号。
- 存储器地址寄存器
	- 用于存放将要访问的主存单元地址。
- 存储器数据寄存器
	- 用于存放想主存写入的信息或从主存中读出的信息。
- 时序系统
	- 用于产生各种时序信号，它们都是由统一时钟Clock分频得到的。
- 微操作信号发生器
	- 根据IR的内容（指令）、PSW 的内容（状态信息）及时序信号，产生控制整个计算 机系统所需的各种控制信号，其结构有组合逻辑型和 存储逻辑型两种。
控制器的工作原理是根据指令操作码、指令的执行步骤（微命令序列）和条件信号来形成当前计算机各部件要用到的控制信号。就是计算机整机各硬件系统在这些控制信号的控制下协同运行，产生预期的执行结果。   
CPU内部寄存器大致分为两类：
- 用户可见的寄存器：
	- 可以对该部分寄存器进行编程
	- 通用寄存器组，程序状态寄存器PSW，程序计数器PC
- 用户不可见的寄存器：
	- 该部分是对用户透明的。不可对这类寄存器编程，
	- 存储器地址寄存器MDR、存储器数据寄存器MAR、指令寄存器IR，暂存寄存器
# 指令执行过程
## 指令周期
指令周期是CPU从主存中取出并执行一条指令所需的全部时间。不同指令的周期可能不同 。指令周期通常用若干个机器周期来表示，机器周期又叫做CPU周期。一个机器周期又包含若干时钟周期（也称为节拍，T周期或CPU时钟周期），它是CPU操作的最基本单位。
一般取指令比较慢，因为涉及到访存。   
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306241600412.png)   
CLK为CPU的脉冲，例如某CPU主频是3.0GHz，则该CPU每秒发出3.0G个CPU时钟周期。   
一个机器周期（包含多个CPU时钟周期）完成执行指令的一个小操作（如取指令）   
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306241605936.png)
每个指令周期数可以不等，每个机器周期内的节拍数也可以不等。   
例如：   
- 空指令NOP
	- 指令执行时，取指结束后什么都不做指令周期结束。
- 加法指令
	- 指令执行时，包括取指周期和执行周期。
- 乘法指令
	- 指令执行时，包括取指周期和执行周期，乘法指令的执行周期一般比加法指令的执行周期要长。 
- 具有间址寻址的指令
	- 指令执行时，包括取指周期，间址周期和执行周期，间址周期需要把形式地址转换为有效地址，需要指令周期更长。
- 带有中断周期的指令
	- 指令执行时，包括取指周期、间址周期、执行周期和中断周期。
有些指令取指后就可以立即执行，有些需要再进行间址寻址等。   
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306241618355.png)
为了区分到底处于哪个周期，在CPU内部设置4个标志触发器FE、IND、EX和INT，它们分别对应取指、间址、执行和中断周期，并以“1”状态表示有效   
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306241621525.png)

## 指令周期的数据流
### 取指周期
主要任务是根据PC中的内容从主存中取出指令代码并存放在IR中。    
数据流如下：  
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306241626066.png)     
### 间址周期
主要任务是取操作数有效地址。如将指令中的地址码送到MAR并送至地址总线，此后CU向存储器发读命令，以获得有效地址并存入MDR。   
数据流如下：   
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306241628522.png)
第一步中，由于取指令时，MDR存放了指令内容，所以取IR与MDR的地址是一样的。  
第三步，得到操作数的有效地址后可以直接放入MAR中，也有的CPU是讲操作数的有效地址拼接到指令地址中。    
### 执行周期
执行周期的任务是根据IR中的指令字的操作码和操作数通过ALU操作产生执行结果，不同指令的执行周期操作不同，因此没有同一的数据流向。
### 中断周期
中断：暂停当前任务去完成其他任务，为了能恢复当前任务，需要保存断点，一般使用堆栈来保存断点，这里使用SP表示栈顶指针。栈一般是地址空间从高到低，入栈是需要SP减1，再放入。       
主要任务是处理中断请求。假设程序断点存入堆栈中，并用SP指示栈顶地址，并且进栈操作是先修改栈顶指针，后存入数据。   
数据流如下：   
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306241648658.png)

## 指令执行方案
### 单指令周期
所有指令的指令周期都是相同的，任何一条指令都延长为最长指令周期的时间，指令之间是串行执行，即下一条指令只能在上一条指令执行完成后才能启动。执行时间取决于执行时间最长的指令的执行时间。   
对于本可以短时间内完成的指令，要用较长周期来完成，会降低整体系统的运行速度。   
### 多指令周期
对于不同类型的指令选用不同的执行步骤来完成。指令之间是串行执行，即下一条指令只能在上一条指令自行完成后才能启动。但是可选用不同个数的时钟周期来完成不同指令的执行过程，指令需要几个周期就给其分配几个周期，但是这样相比单指令周期需要更复杂的硬件设计。   
### 流水线方案
指令之间可以并行执行的方案，称为流水线方案，其追求的目的是力争每个时钟脉冲周期完成一条指令的执行过程。这种方案在每一个时钟周期启动一条指令，尽量让多条指令同时运行，但各自处在不同的执行步骤。   
# 数据通路的功能和基本结构
## 数据通路的功能
数据在功能部件之间传送的路径称为数据通路，包括数据通路上流经的部件，如ALU、通用寄存器、状态寄存器、异常和中断处理逻辑等。数据通路描述了信息从什么地方开始。中间经过哪个寄存器或多路开关，最后传送到哪个寄存器，这些都需要加以控制。   
数据通路由控制部件控制，控制部件根据每条指令功能的不同生成对数据通的控制信号。数据通路的功能是实现CPU内部的运算器与寄存器及寄存器之间的数据交换。    
## 数据通路的基本结构
数据通路的基本结构有以下几种：  
#### CPU内部单总线方式
将所有寄存器的输入端和输出端都连接到一条公共通路上，这种结构比较简单，但是会出现冲突的现象，性能较低。连接各部件只有一条总线时，为单总线方式。   
#### CPU内部多总线方式
将所有寄存器的输入端和输出端都连接到多条公共通路上，相比单总线上一个时钟周期只允许传一个数据，指令效率较低，采用多条总线方式可以在多个总线上传送不同的数据，提高效率。  
#### 专用数据通路方式
根据指令执行过程中的数据和地址的流动方向安排连接线路，避免使用共享的总线，性能较高，但硬件量大。
**内部总线**：同一部件，指CPU内部连接各寄存器及运算部件之间的总线。   
**系统总线**：同一台计算机系统的各部件，如CPU、内存、通道和各类I/O接口间相互连接的总线。  
## 单总线结构
### 寄存器之间数据传送
比如把PC内容送到MAR，实现传送操作的流程及控制信号为：   
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306241811863.png)

（PC）->BUS  PCout有效，PC内容送到总线；     
BUS->MAR  MARin有效，总线内容送到MAR；   
### 主存与CPU之间数据传送
比如CPU从主存读取指令，实现传送操作及控制信号为：   
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306241811374.png)

（PC）-> BUS ->MAR  PCout和MARin有效，现行指令地址->MAR      
1->R    CU发读命令（通过控制总线发出，图中未画出） 
MEM(MAR)->MDR   MDRin有效（将主存中的MAR对应的信息输入MDR中，图中未画出）      
MDR->BUS->IR   MDRout和IRin有效，现行指令->IR   
### 执行算术或逻辑运算
执行算数和逻辑操作时，由于ALU内部没有存储功能的组合电路，因此如果要执行加法运算，相加的两个数必须在ALU的两个输入端同时有效，而暂存寄存器就是将其中一个数与ALU一个输入端进行连接，另外一个数通过总线与另一个输入端进行连接，最终结果暂存到暂存器Z中。   
比如执行一条加法指令，微操作序列及控制信号为： 
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306241825427.png)

Ad(IR)->BUS->MAR    MDRout和MARin有效 
1->R     CU发出读命令
MEM(MAR)->MDR   MDRin有效
MDR->BUS->Y   MDRout和Yin有效，操作数->Y
(ACC)+Y->Z    ACCout和ALUin有效，CU向ALU发送加命令   
Z->ACC     Zout和ACCin有效
## 专用数据通路
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306261630174.png)
其中C<sub>1</sub>~C<sub>12</sub>为控制信号，控制这条线的连通，与MARin、MARout作用类似。
#### 取指令

## 例题
分析各阶段的微操作序列和控制信号

# 控制器的功能和工作原理
## 控制器的结构和功能
高级语言代码被翻译为多条指令，每条指令的执行可能分为4个周期，取指周期FEtch、间址周期INDirect、执行周期EXecute、中断周期INTerpret。   
CU发出一个微命令，可以完成对应微操作，如：微命令1可以使PCout、MARin有效。完成对应的微操作1（PC）->MAR。如果是多总线结果或专用数据通路，可以在一个节拍并行执行多个“相融的”微操作。同一个微操作可能在不同指令的不同阶段被使用。    
不同指令的执行周期所需的节拍数不同，但是为了简化设计，可以选择定长机器周期，以可能出现的最大节拍数为准（通常以访存所需节拍数作为参考）    
若实际所需节拍数较少，可将微操作安排在极期后期末尾的几个节拍上进行。   
根据指令操作码、目前的机器周期、节拍信号、机器状态条件，即可以确定这个节拍下应该发出哪些“微命令”。    
### 微操作指令分类
#### 非访存指令
- CLA 清0
- COM 取反
- SHR 算数右移
- CSL 循环左移
- STP 停机指令
#### 访存指令
- ADD X 加法指令
- STA X 存数指令
- LAD X 取数指令
#### 转移指令
- JMP X 无条件转移
- BAN X条件转移
## 硬布线控制器
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306261746532.png)

- 指令操作码
	- 指令寄存器IR传入n位操作码，经操作码译码器处理后传入控制单元
	- 用于判断指令内容
- 当前机器周期
	- 有FE、IND、EX、INT4个触发器分别表示取指、间址、执行、中断四个周期，传给CU来表示处于哪个机器周期。
	- 这个四个触发器一般集成在CU内部
- 节拍信号
	- 时钟脉冲信号传入节拍发生器，每个时钟周期发出一个节拍信号，有T<sub>1</sub>-T<sub>m</sub>多个输出，循环发出。
	- 用于表示节拍信号。
- 机器状态条件
	- 标志来自执行单元的反馈信息，例如来自运算器的PSW、ACC的符号位等、也可能来自I/O设备、主存等。
	- 这些信号可能会影响微操作的执行。
- 控制信号输出
	- CU接受信号输入后，输出控制信号，每个输出的控制信号对应一个微命令，例如要让C<sub>1</sub>对应微操作（PC）->MAR，则将其接入到PCout和MARin上。
	- 例如，所以指令的取指周期，T<sub>0</sub>节拍下要完成（PC）->MAR，则可以让C<sub>1</sub> = FE ^ T<sub>0</sub>。  
例如：   
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306261747151.png)
### 硬布线控制器的设计
1. 分析每个阶段的微操作序列（取指、间址、执行、中断四个阶段）    确定指令在哪个阶段，在什么条件下使用什么微操作。   
2. CPU的控制方式    采用定长机器周期还是不定长，每个机器周期安排几个节拍
3. 安排微操作时序   例如如何用3个节拍完成整个机器周期内的所有微操作。 
4. 电路设计   根据微操作命令设计的逻辑表达式用电路实现    

### 组合逻辑设计
- 分析每个阶段的微操作序列
- 选择CPU的控制方式
- 安排微操作时序
- 电路设计
	- 列出微操作命令的操作时间表
	- 进行微操作信号综合
		- 微操作控制信号=机器周期^节拍^脉冲^操作码^机器状态条件
	- 画出微操作命令的逻辑图，根据逻辑表达式画出对应的逻辑电路。
硬布线控制器特点：   
指令越多、设计和实现越复杂，因此一般用于RISC（精简指令集），扩充一条新指令比较困难，需要大改。    
但是采用纯硬件实现控制，执行速度非常快。   
## 微程序控制器
采用“存储程序的思想”，CPU出厂前将所有指令的“微程序”存入“控制器存储器”中。   
微操作与微操作等同，微指令包括多个微命令。   
每一种指令对应一个微程序。    

### 基本结构
每个微程序包括多个微指令，每条微指令对应一个   
- 微地址形成部件：
	- 微地址即微指令在CM中的存放地址。通过指令操作码形成对应微程序的第一条微指令的存放地址
- 顺序逻辑
	- 根据某些机器标志和时序信息确定下一条微指令的存放地址
- 控制存储器CM：
	- 用于存放个指令对应的微程序（微指令序列，按地址寻访。
	- 控制存储器可用只读存储器ROM构成，通常在CPU出厂时就把所有微程序写入。   
- 微地址寄存器CMAR或μPC：
	- 用于存放控制存储器读写微指令的地址。指明接下来要执行的微指令的存放地址。     
- 微指令寄存器CMDR或μIR：
	- 用于存放从控制器中读出的微指令，即当前要执行的指令。CM（μPC）->μIR   
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306262058353.png)
### 控制存储器工作原理
取指周期、间址周期、中断周期的微程序一般是公用的，如果某指令系统中有n条机器指令，则CM中微程序端的个数至少为n+1个。（可能没有间址周期和中断周期）    
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306262110286.png)
一般而言取指周期的微指令序列固定从#0开始放，执行周期的微指令序列各不相同， 
### 概念对比
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306262132817.png)
每条机器指令（比如让A+1）编写为一个微程序，每个微程序由多个微指令（例如取指令），每条微指令又对应多个微操作或微命令（比如（PC）->MAR，1->R这；两个微命令)。   
## 微指令的设计
### 微指令的格式
相容性微命令：可以并行完成的微命令。   
互斥性微命令：不允许并行完成的微命令。   
#### 水平型微指令
一条微指令能定义多个可并行的微命令。  
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306262148588.png)

微程序段，执行速度快。   
#### 垂直型微指令
一条微指令只能定义一个微命令，由微操作码字段规定具体功能。    
![image.png](https://cdn.staticaly.com/gh/ivylet/blog_picg-@master/img/202306262148963.png)
  
#### 混合型微指令
# 异常和中断机制
# 指令流水线
# 多处理器的基本概念
